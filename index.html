<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TabSync Dashboard</title>
  <meta name="color-scheme" content="dark">
  <style>
    :root{
      --bg:#0b0b0c;
      --bg-grad-1:rgba(10,132,255,.16);
      --bg-grad-2:rgba(88,86,214,.12);
      --card:#17171a;
      --text:#f5f5f7;
      --muted:#a1a1a6;
      --line:#2a2a2f;
      --blue:#0a84ff;
      --blue-2:#3aa0ff;
      --red:#ff453a;

      --radius-xl:20px;
      --shadow:0 18px 70px rgba(0,0,0,.6), inset 0 1px 0 rgba(255,255,255,.02);
    }

    *{ box-sizing:border-box; margin:0; padding:0; }
    html, body{ height:100%; overflow-x:hidden; }

    /* ===== Background (v1 look, no bottom seam) ===== */
    body{
      background:
        radial-gradient(1200px 800px at 10% -10%, var(--bg-grad-1), transparent 60%),
        radial-gradient(1000px 700px at 90% -20%, var(--bg-grad-2), transparent 55%),
        linear-gradient(180deg, #0a0a0c 0%, #0b0b0c 100%);
      background-repeat:no-repeat;
      background-color:var(--bg);
      color:var(--text, #f5f5f7);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","SF Pro Text","Segoe UI",Roboto,Inter,system-ui,sans-serif;
      line-height:1.65;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      letter-spacing:.01rem;
      min-height:100vh;
      position:relative;
    }
    body::before{
      content:"";
      position:fixed; inset:0; pointer-events:none; z-index:0;
      background:
        radial-gradient(ellipse at 50% 0%, rgba(255,255,255,.04), transparent 70%),
        linear-gradient(180deg, rgba(255,255,255,.03) 0%, transparent 100%);
    }

    /* ===== Top Nav ===== */
    .header{
      position:sticky; top:0; z-index:50;
      backdrop-filter:saturate(140%) blur(16px);
      background:linear-gradient(to bottom, rgba(17,17,20,.86), rgba(17,17,20,.58));
      border-bottom:1px solid rgba(255,255,255,.05);
    }
    .header-content{
      max-width:1400px;
      margin:0 auto;
      padding:14px clamp(20px, 5vw, 48px);
      display:flex; align-items:center; justify-content:space-between;
    }
    .brand{display:flex; align-items:center; gap:12px}
    .brand-logo{width:24px;height:24px;border-radius:8px;background:radial-gradient(120% 120% at 30% 20%, #3aa0ff 0%, #0a84ff 40%, #0048b3 100%);box-shadow:0 10px 30px rgba(10,132,255,.45), inset 0 1px 0 rgba(255,255,255,.25)}
    .logo{font-weight:800; font-size:19px; letter-spacing:.2px}
    .user-section{display:flex; align-items:center; gap:10px}
    .user-info{color:var(--muted); font-size:14px}

    /* ===== Buttons ===== */
    .btn{
      appearance:none;border:0;cursor:pointer;border-radius:10px;
      padding:8px 14px;font-weight:600;font-size:14px;
      transition:transform .15s ease, box-shadow .25s ease, background .25s ease, opacity .2s ease;
      will-change:transform;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn-ghost{background:rgba(255,255,255,.06); color:var(--text); box-shadow:var(--shadow)}
    .btn-blue{background:linear-gradient(180deg, var(--blue) 0%, #056ee6 100%); color:#fff; box-shadow:0 10px 30px rgba(10,132,255,.35)}
    .btn-blue.soft{
      background:rgba(10,132,255,.14);
      color:#d8ebff;
      border:1px solid rgba(10,132,255,.35);
      box-shadow:none;
    }
    .btn-red{background:linear-gradient(180deg, #ff5a52 0%, var(--red) 100%); color:#fff; box-shadow:0 10px 28px rgba(255,69,58,.35)}

    /* ===== Shell ===== */
    .shell{
      max-width:1400px;
      margin:0 auto;
      padding:30px 0 70px;
      padding-left:clamp(24px, 6vw, 64px);
      padding-right:clamp(16px, 3vw, 40px);
    }

    /* ===== Stats ===== */
    .stats{
      display:grid; grid-template-columns:repeat(12, minmax(0,1fr)); gap:16px;
      margin:16px 0 18px;
    }
    .stat{
      grid-column:span 3;
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--radius-xl);
      padding:14px 16px;
      min-height:96px;
      box-shadow:var(--shadow);
      display:flex; align-items:flex-end; justify-content:space-between;
      overflow:hidden; position:relative; isolation:isolate;
    }
    .stat-num{font-size: clamp(28px, 3.6vw, 40px); font-weight:800; letter-spacing:-.02em; line-height:1}
    .stat-label{color:var(--muted); font-size:13px; margin-top:6px}
    .stat-chip{font-size:11px; color:#8df0b3; background:rgba(48,209,88,.12); border:1px solid rgba(48,209,88,.25); padding:5px 9px; border-radius:999px}

    /* ===== Toolbar (no awkward spacer) ===== */
    .toolbar{
      margin:8px 0 8px;
      display:grid;
      grid-template-columns: minmax(260px,560px) 190px auto auto auto; /* search | sort | dates | refresh | copy-all */
      gap:14px; align-items:center;
    }
    .search{
      background:rgba(255,255,255,.06); border:1px solid var(--line);
      border-radius:12px; display:flex; align-items:center; gap:10px; padding:10px 12px;
    }
    .search input{background:transparent; border:0; outline:0; color:var(--text); width:100%; font-size:15px}

    .select{
      position:relative;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      padding:10px 36px 10px 12px;
      border-radius:12px;
      font-size:14px;
      appearance:none;
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="white" opacity="0.8"><path d="M7 10l5 5 5-5z"/></svg>');
      background-repeat:no-repeat;
      background-position:right 10px center;
      background-size:16px;
    }
    .select option{background:#121214; color:var(--text);}

    .date-wrap{display:flex; gap:10px}
    .date{
      background:rgba(255,255,255,.06); border:1px solid var(--line);
      color:var(--text); padding:10px 12px; border-radius:12px; font-size:14px;
    }

    .btn-row{display:flex; gap:12px}

    /* ===== Groups ===== */
    .groups{display:flex; flex-direction:column; gap:18px; margin-top:6px;}
    .card{
      border-radius:var(--radius-xl);
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04)), var(--card);
      box-shadow:var(--shadow);
      overflow:hidden;
      opacity:0; transform:translateY(8px) scale(.997);
      animation:rise .45s cubic-bezier(.19,.8,.22,1) forwards;
    }
    @keyframes rise{to{opacity:1; transform:translateY(0) scale(1)}}

    .card-head{
      display:flex; align-items:flex-start; justify-content:space-between; gap:14px;
      padding:18px 20px 10px 20px;
      border-bottom:1px solid rgba(255,255,255,.05);
    }
    .title-row{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .title{font-weight:800; font-size:20px; letter-spacing:.1px}
    .chip{
      padding:6px 10px; border-radius:999px; font-size:12px; font-weight:700; letter-spacing:.2px;
      border:1px solid rgba(255,255,255,.10); color:#e9ecf3; background:rgba(255,255,255,.06);
    }
    .chip.neutral{border-color:rgba(10,132,255,.28); background:rgba(10,132,255,.14); color:#d8ebff}

    .actions{display:flex; gap:10px; flex-wrap:wrap}
    .pill{
      padding:8px 14px; border-radius:999px; font-weight:700; font-size:13px;
      border:1px solid rgba(255,255,255,.08); background:rgba(255,255,255,.06);
      cursor:pointer; transition:transform .15s ease, background .15s ease, box-shadow .2s ease;
    }
    .pill:hover{transform:translateY(-1px); background:rgba(255,255,255,.09); box-shadow:0 8px 18px rgba(0,0,0,.3)}
    .pill.blue{border-color:rgba(10,132,255,.35); background:linear-gradient(180deg, rgba(10,132,255,.20), rgba(10,132,255,.10)); color:#e6f3ff}
    .pill.red{border-color:rgba(255,69,58,.35); background:linear-gradient(180deg, rgba(255,69,58,.20), rgba(255,69,58,.10)); color:#ffe9e7}

    .card-body{padding:6px 20px 18px 20px}
    .tabs{display:flex; flex-direction:column; gap:8px}
    .tab{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:12px;
      transition:transform .18s ease, background .18s ease, box-shadow .25s ease;
      background:transparent;
    }
    .tab:hover{background:rgba(255,255,255,.06); transform:translateY(-1px); box-shadow:0 12px 24px rgba(0,0,0,.3), inset 0 1px 0 rgba(255,255,255,.04)}
    .fav{width:18px; height:18px; border-radius:4px; flex:0 0 18px}
    .link{color:var(--blue-2); text-decoration:none; word-break:break-all; font-weight:600; letter-spacing:.1px}
    .link:hover{text-decoration:underline; color:#6ebdff}

    /* collapsed state (default) */
    .card.collapsed .card-body{display:none}

    /* ===== Login / Loading / Empty / Toast ===== */
    .login{display:grid; place-items:center; min-height:70vh; padding:0 clamp(24px,6vw,64px)}
    .login-card{width:min(560px, 92vw); background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04)); border:1px solid var(--line); border-radius:var(--radius-xl); padding:36px 32px; box-shadow:var(--shadow); text-align:center}
    .login h1{font-size:28px; font-weight:800; margin-bottom:8px}
    .login p{color:var(--muted); margin-top:8px}
    .btn-google{margin-top:18px; width:100%; padding:12px 16px; border-radius:12px; border:1px solid rgba(255,255,255,.08); background:linear-gradient(180deg, rgba(10,132,255,.22), rgba(10,132,255,.12)); color:#e6f3ff; font-weight:800; letter-spacing:.2px; box-shadow:0 12px 28px rgba(10,132,255,.25)}

    .loading-row{display:grid; gap:14px}
    .skeleton{height:70px; border-radius:16px; background:linear-gradient(90deg, rgba(255,255,255,.04), rgba(255,255,255,.08), rgba(255,255,255,.04)); animation:shim 1.4s infinite linear; background-size:200% 100%}
    @keyframes shim{to{background-position:-200% 0}}

    .empty{color:var(--muted); padding:30px; text-align:center}

    .toast{position:fixed; top:88px; right:26px; z-index:60; background:linear-gradient(180deg, rgba(10,132,255,.9), rgba(10,132,255,.75)); color:#fff; padding:12px 16px; border-radius:12px; box-shadow:0 18px 40px rgba(10,132,255,.35); opacity:0; transform:translateY(-8px); transition:all .28s ease}
    .toast.show{opacity:1; transform:translateY(0)}
    .toast.error{background:linear-gradient(180deg, rgba(255,69,58,.92), rgba(255,69,58,.78)); box-shadow:0 18px 40px rgba(255,69,58,.35)}

    @media (max-width:1024px){
      .stat{grid-column:span 4}
      .toolbar{grid-template-columns: 1fr 160px auto auto auto}
    }
    @media (max-width:760px){
      .stat{grid-column:span 6}
      .toolbar{grid-template-columns:1fr; gap:10px}
      .btn-row{justify-self:start}
      .date-wrap{justify-content:flex-start}
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="brand">
        <div class="brand-logo" aria-hidden="true"></div>
        <div class="logo">TabSync</div>
      </div>
      <div class="user-section">
        <div id="userInfo" class="user-info"></div>
        <button id="logoutBtn" class="btn btn-ghost">Sign out</button>
      </div>
    </div>
  </header>

  <!-- Shell -->
  <main class="shell">
    <!-- Login -->
    <section id="loginSection" class="login" style="display:none">
      <div class="login-card">
        <h1>Welcome back</h1>
        <p>Access your saved tab groups anywhere. Sign in to sync.</p>
        <button id="googleLoginBtn" class="btn btn-google">Sign in with Google</button>
      </div>
    </section>

    <!-- Dashboard -->
    <section id="mainContent" style="display:none">
      <!-- Stats -->
      <div class="stats" aria-live="polite">
        <div class="stat">
          <div>
            <div id="totalGroups" class="stat-num">0</div>
            <div class="stat-label">Saved Groups</div>
          </div>
          <div class="stat-chip">Synced</div>
        </div>
        <div class="stat">
          <div>
            <div id="totalTabs" class="stat-num">0</div>
            <div class="stat-label">Total Tabs</div>
          </div>
          <div class="stat-chip">Up to date</div>
        </div>
      </div>

      <!-- Toolbar -->
      <div class="toolbar">
        <div class="search">
          <svg width="16" height="16" fill="currentColor" style="opacity:.6"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398l3.85 3.85a1 1 0 0 0 1.415-1.415l-3.868-3.833zM6.5 11a4.5 4.5 0 1 1 0-9 4.5 4.5 0 0 1 0 9z"/></svg>
          <input id="searchInput" type="search" placeholder="Search groups or URLs…" autocomplete="off">
        </div>
        <select id="sortSelect" class="select" title="Sort">
          <option value="new">Newest</option>
          <option value="old">Oldest</option>
          <option value="az">A → Z</option>
          <option value="za">Z → A</option>
          <option value="tabs">Tabs (High → Low)</option>
        </select>
        <div class="date-wrap">
          <input id="startDate" class="date" type="date" aria-label="Start date">
          <input id="endDate" class="date" type="date" aria-label="End date">
        </div>
        <div class="btn-row">
          <button id="refreshBtn" class="btn btn-blue soft" title="Reload groups">Refresh</button>
          <button id="copyAllBtn" class="btn btn-ghost" title="Copy links from the filtered view">Copy All Links</button>
        </div>
      </div>

      <!-- Loading -->
      <div id="loading" class="loading-row" style="display:none">
        <div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>
      </div>

      <!-- Empty -->
      <div id="emptyState" class="empty" style="display:none">
        <div style="font-size:28px;margin-bottom:6px;opacity:.9">No tab groups yet</div>
        <div class="muted">Save a group from the extension to see it here.</div>
      </div>

      <!-- Groups -->
      <div id="groupsList" class="groups" aria-live="polite"></div>
    </section>
  </main>

  <!-- Toast -->
  <div id="statusMessage" class="toast" role="status" aria-live="polite"></div>

  <script>
    // ===== Config =====
    const API_BASE = 'https://tabsync-backend.onrender.com';

    // ===== State / DOM =====
    let currentUser = null;
    let groups = [];
    let filteredGroups = [];
    const collapsedState = {}; // groupId -> bool (false = hidden by default)

    const loginSection = document.getElementById('loginSection');
    const mainContent = document.getElementById('mainContent');
    const userInfo = document.getElementById('userInfo');
    const logoutBtn = document.getElementById('logoutBtn');
    const googleLoginBtn = document.getElementById('googleLoginBtn');

    const refreshBtn = document.getElementById('refreshBtn');
    const loading = document.getElementById('loading');
    const emptyState = document.getElementById('emptyState');
    const groupsList = document.getElementById('groupsList');
    const totalGroups = document.getElementById('totalGroups');
    const totalTabs = document.getElementById('totalTabs');
    const statusMessage = document.getElementById('statusMessage');

    const searchInput = document.getElementById('searchInput');
    const sortSelect = document.getElementById('sortSelect');
    const copyAllBtn = document.getElementById('copyAllBtn');
    const startDate = document.getElementById('startDate');
    const endDate = document.getElementById('endDate');

    document.addEventListener('DOMContentLoaded', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const authCode = urlParams.get('code');
      if (authCode) {
        await handleAuthCallback(authCode);
      } else {
        const user = getStoredUser();
        if (user) await showDashboard(user);
        else showLogin();
      }
    });

    googleLoginBtn?.addEventListener('click', handleGoogleLogin);
    logoutBtn.addEventListener('click', handleLogout);

    // search fix: input + keyup + debounce
    const debounce = (fn, ms=120) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };
    const runSearch = debounce(() => { applyFilters(); renderGroups(); }, 120);
    searchInput.addEventListener('input', runSearch);
    searchInput.addEventListener('keyup', runSearch);

    sortSelect.addEventListener('change', () => { applyFilters(); renderGroups(); });
    startDate.addEventListener('change', () => { applyFilters(); renderGroups(); });
    endDate.addEventListener('change', () => { applyFilters(); renderGroups(); });

    refreshBtn.addEventListener('click', loadGroups);
    copyAllBtn.addEventListener('click', copyAllLinks);

    // ===== Auth =====
    async function handleGoogleLogin() {
      try {
        googleLoginBtn.disabled = true;
        googleLoginBtn.textContent = 'Signing in…';

        const clientId = '754594078949-26dhhpri61i96967opn4pinbmjc208hp.apps.googleusercontent.com';
        const redirectUri = window.location.origin + window.location.pathname;
        const scope = 'openid email profile';

        const authUrl =
          'https://accounts.google.com/o/oauth2/v2/auth' +
          `?client_id=${encodeURIComponent(clientId)}` +
          `&redirect_uri=${encodeURIComponent(redirectUri)}` +
          `&response_type=code` +
          `&scope=${encodeURIComponent(scope)}` +
          `&access_type=offline` +
          `&prompt=consent`;

        window.location.href = authUrl;
      } catch (err) {
        console.error('Login failed:', err);
        showStatus('Sign in failed. Try again.', 'error');
        googleLoginBtn.disabled = false;
        googleLoginBtn.textContent = 'Sign in with Google';
      }
    }

    async function handleAuthCallback(code) {
      try {
        const resp = await fetch(`${API_BASE}/auth/google/callback`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            code,
            redirect_uri: window.location.origin + window.location.pathname
          })
        });

        if (!resp.ok) {
          const detail = await resp.text();
          console.error('OAuth exchange failed:', detail);
          showStatus('Authentication failed: ' + detail, 'error');
          showLogin();
          return;
        }

        const data = await resp.json();
        storeUser(data.user);
        window.history.replaceState({}, document.title, window.location.pathname);
        await showDashboard(data.user);
        showStatus('Signed in successfully!');
      } catch (err) {
        console.error('Auth callback error:', err);
        showStatus('Authentication failed. Please try again.', 'error');
        showLogin();
      }
    }

    // ===== UI helpers =====
    function showLogin() {
      loginSection.style.display = 'grid';
      mainContent.style.display = 'none';
      document.querySelector('.user-section').style.display = 'none';
    }

    async function showDashboard(user) {
      currentUser = user;
      loginSection.style.display = 'none';
      mainContent.style.display = 'block';
      document.querySelector('.user-section').style.display = 'flex';
      userInfo.textContent = user.email;
      await loadGroups();
    }

    function showStatus(message, type='success') {
      statusMessage.textContent = message;
      statusMessage.className = `toast ${type === 'error' ? 'error' : ''} show`;
      setTimeout(() => { statusMessage.className = 'toast'; }, 3000);
    }

    function getStoredUser() {
      const s = localStorage.getItem('tabsync_user');
      return s ? JSON.parse(s) : null;
    }
    function storeUser(user) { localStorage.setItem('tabsync_user', JSON.stringify(user)); }
    function clearStoredUser() { localStorage.removeItem('tabsync_user'); }
    async function handleLogout(){ clearStoredUser(); location.reload(); }

    // ===== Data =====
    async function loadGroups() {
      try {
        loading.style.display = 'grid';
        emptyState.style.display = 'none';
        groupsList.innerHTML = '';

        const res = await fetch(`${API_BASE}/api/groups`, {
          headers: { Authorization: `Bearer ${currentUser.token}` }
        });
        if (!res.ok) throw new Error('Failed to load groups');

        const data = await res.json();
        groups = Array.isArray(data.groups) ? data.groups : [];
        applyFilters();
        renderGroups();

        loading.style.display = 'none';
        emptyState.style.display = filteredGroups.length ? 'none' : 'block';

        updateStats();
      } catch (err) {
        console.error('Failed to load groups:', err);
        loading.style.display = 'none';
        showStatus('Failed to load groups. Please try again.', 'error');
      }
    }

    // search + sort + date range
    function applyFilters(){
      const q = (searchInput.value || '').trim().toLowerCase();
      const sort = sortSelect.value;

      const sVal = startDate.value ? new Date(startDate.value + 'T00:00:00') : null;
      const eVal = endDate.value ? new Date(endDate.value + 'T23:59:59') : null;

      filteredGroups = groups
        .filter(g => {
          if(q){
            const inName = (g.name || '').toLowerCase().includes(q);
            const inUrls = (g.urls || []).some(u => (u || '').toLowerCase().includes(q));
            if(!inName && !inUrls) return false;
          }
          if(sVal || eVal){
            const d = new Date(g.createdAt || 0);
            if(sVal && d < sVal) return false;
            if(eVal && d > eVal) return false;
          }
          return true;
        })
        .sort((a,b)=>{
          if(sort === 'new') return new Date(b.createdAt) - new Date(a.createdAt);
          if(sort === 'old') return new Date(a.createdAt) - new Date(b.createdAt);
          if(sort === 'az') return (a.name||'').localeCompare(b.name||'');
          if(sort === 'za') return (b.name||'').localeCompare(a.name||'');
          if(sort === 'tabs') return (b.tabCount||b.urls?.length||0) - (a.tabCount||a.urls?.length||0);
          return 0;
        });
    }

    function renderGroups() {
      groupsList.innerHTML = filteredGroups.map((group, idx) => {
        const date = formatDate(group.createdAt);
        const tabCount = (group.tabCount ?? group.urls?.length ?? 0);
        const collapsed = collapsedState[group.id] ?? true; // default hidden

        return `
        <article class="card ${collapsed ? 'collapsed' : ''}" style="animation-delay:${idx*40}ms" id="card-${group.id}">
          <header class="card-head">
            <div>
              <div class="title-row" style="align-items:center; gap:10px;">
                <div class="title">${escapeHtml(group.name || 'Untitled Group')}</div>
                <span class="chip neutral" title="Tabs in this group">${tabCount} tabs</span>
                <span class="chip" title="Saved on">${escapeHtml(date)}</span>
              </div>
            </div>
            <div class="actions">
              <button class="pill blue" title="Open all links in a new window" onclick="openGroup('${group.id}')">Open All</button>
              <button class="pill" data-action="toggle" title="Show or hide the link list" onclick="toggleLinks('${group.id}')">${collapsed ? 'Show' : 'Hide'} Links</button>
              <button class="pill" title="Copy this group’s links" onclick="copyGroupLinks('${group.id}')">Copy Links</button>
              <button class="pill" title="Download this group as JSON" onclick="exportGroup('${group.id}')">Export JSON</button>
              <button class="pill red" title="Delete this group" onclick="deleteGroup('${group.id}')">Delete</button>
            </div>
          </header>
          <div class="card-body">
            <div class="tabs">
              ${(group.urls || []).map(u => `
                <div class="tab">
                  <img class="fav" src="https://www.google.com/s2/favicons?sz=64&domain_url=${u}" alt="">
                  <a class="link" href="${u}" target="_blank" rel="noopener noreferrer">${escapeHtml(u)}</a>
                </div>
              `).join('')}
            </div>
          </div>
        </article>`;
      }).join('');
    }

    function updateStats() {
      totalGroups.textContent = groups.length;
      totalTabs.textContent = groups.reduce((sum, g) => sum + (g.tabCount ?? g.urls?.length ?? 0), 0);
    }

    // ===== Toggle show/hide links =====
    function toggleLinks(groupId){
      collapsedState[groupId] = !(collapsedState[groupId] ?? true);
      const el = document.getElementById(`card-${groupId}`);
      if(!el) return;
      el.classList.toggle('collapsed');
      // update button label confidently (only the toggle button has data-action="toggle")
      const btn = el.querySelector('.actions .pill[data-action="toggle"]');
      if(btn) btn.textContent = (collapsedState[groupId] ? 'Show' : 'Hide') + ' Links';
    }

    // ===== Actions =====
    function openGroup(groupId) {
      const group = groups.find(g => g.id === groupId);
      if (!group || !Array.isArray(group.urls) || group.urls.length === 0) {
        showStatus('No URLs found in this group.', 'error'); return;
      }
      if (group.urls.length > 10 && !confirm(`Open ${group.urls.length} tabs in a new window?`)) return;

      const newWindow = window.open('about:blank', '_blank', 'noopener,noreferrer,width=1200,height=800');
      if (!newWindow) { showStatus('Popup blocked. Enable popups for this site.', 'error'); return; }

      const payload = JSON.stringify(group.urls);
      const safeName = escapeHtml(group.name || 'Group');
      const script = `
        const urls = ${payload};
        urls.forEach((u, i) => setTimeout(()=>window.open(u, '_blank'), i*160));
        document.body.style.fontFamily='-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,system-ui,sans-serif';
        document.body.style.background='#0b0b0c'; document.body.style.color='#f5f5f7';
        document.body.style.display='grid'; document.body.style.placeItems='center'; document.body.style.height='100vh';
        document.body.innerHTML = '<div style="opacity:.9;text-align:center"><div style="font-size:22px;font-weight:800;margin-bottom:6px">Opening ${group.urls.length} tabs</div><div style="color:#a1a1a6">from “${safeName}”. You can close this window.</div></div>';
      `;
      newWindow.document.write(`<script>${script}<\/script>`);
      showStatus(`Opening ${group.urls.length} tabs from "${group.name}"…`);
    }

    async function deleteGroup(groupId) {
      const group = groups.find(g => g.id === groupId);
      if (!group) return;
      if (!confirm(`Delete "${group.name}"? This cannot be undone.`)) return;

      const res = await fetch(`${API_BASE}/api/groups/${groupId}`, {
        method: 'DELETE',
        headers: { Authorization: `Bearer ${currentUser.token}` }
      });
      if (!res.ok) { showStatus('Failed to delete group.', 'error'); return; }

      groups = groups.filter(g => g.id !== groupId);
      applyFilters(); renderGroups();
      emptyState.style.display = groups.length ? 'none' : 'block';
      updateStats();
      showStatus(`Deleted "${group.name}"`);
    }

    function copyGroupLinks(groupId){
      const group = groups.find(g => g.id === groupId);
      if(!group) return;
      const text = (group.urls || []).join('\n');
      navigator.clipboard.writeText(text).then(
        ()=>showStatus(`Copied ${group.urls.length} links to clipboard`),
        ()=>showStatus('Copy failed', 'error')
      );
    }

    // respects filters
    function copyAllLinks(){
      const source = (filteredGroups && filteredGroups.length) ? filteredGroups : groups;
      const all = source.flatMap(g => g.urls || []);
      if(!all.length){ showStatus('No links to copy', 'error'); return; }
      navigator.clipboard.writeText(all.join('\n')).then(
        ()=>showStatus(`Copied ${all.length} links`),
        ()=>showStatus('Copy failed', 'error')
      );
    }

    function exportGroup(groupId){
      const group = groups.find(g => g.id === groupId);
      if(!group) return;
      const blob = new Blob([JSON.stringify(group, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `${(group.name||'tabsync-group').replace(/[^\w\-]+/g,'_')}.json`;
      document.body.appendChild(a); a.click(); a.remove();
      showStatus('Export started');
    }

    // ===== Utils =====
    function escapeHtml(text){const d=document.createElement('div');d.textContent=String(text ?? '');return d.innerHTML;}
    function formatDate(s){ if(!s) return '—'; const d=new Date(s); return d.toLocaleDateString(); }
  </script>
</body>
</html>
