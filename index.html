<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TabSync Dashboard</title>
  <style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
    background: #f5f6f8;
    color: #1c1c1e;
    line-height: 1.6;
  }

  .header {
    background: #fff;
    border-bottom: 1px solid #e5e5e7;
    padding: 18px 40px;
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .header-content {
    max-width: 1100px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .logo {
    font-size: 26px;
    font-weight: 700;
    color: #0071e3;
    letter-spacing: -0.5px;
  }

  .user-section {
    display: flex;
    align-items: center;
    gap: 14px;
  }

  .user-info {
    font-size: 15px;
    color: #555;
  }

  .logout-btn {
    background: #f2f2f7;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    color: #333;
    transition: all 0.2s ease;
  }

  .logout-btn:hover {
    background: #e5e5ea;
  }

  .container {
    max-width: 1100px;
    margin: 0 auto;
    padding: 32px 40px;
    text-align: left;
  }

  .stats-grid {
    display: flex;
    gap: 24px;
    margin-bottom: 40px;
  }

  .stat-card {
    flex: 1;
    background: #fff;
    border-radius: 14px;
    padding: 28px;
    border: 1px solid #e5e5e7;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
  }

  .stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  }

  .stat-value {
    font-size: 42px;
    font-weight: 700;
    color: #0071e3;
    margin-bottom: 6px;
  }

  .stat-label {
    font-size: 16px;
    color: #777;
    font-weight: 500;
  }

  .groups-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .groups-title {
    font-size: 24px;
    font-weight: 600;
    color: #111;
  }

  .refresh-btn {
    background: #0071e3;
    color: #fff;
    border: none;
    padding: 10px 18px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 15px;
    transition: background 0.2s;
  }

  .refresh-btn:hover {
    background: #005bb5;
  }

  .groups-list {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .group-card {
    background: #fff;
    border-radius: 14px;
    border: 1px solid #e5e5e7;
    padding: 24px 28px;
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
    transition: all 0.25s ease;
  }

  .group-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06);
  }

  .group-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
  }

  .group-name {
    font-size: 20px;
    font-weight: 600;
    color: #111;
  }

  .group-meta {
    font-size: 13px;
    color: #777;
  }

  .group-actions {
    display: flex;
    gap: 10px;
  }

  .open-btn,
  .delete-btn {
    border: none;
    padding: 8px 14px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
  }

  .open-btn {
    background: #0071e3;
    color: white;
  }

  .open-btn:hover {
    background: #005bb5;
  }

  .delete-btn {
    background: #ff3b30;
    color: white;
  }

  .delete-btn:hover {
    background: #d9362b;
  }

  .tab-list {
    font-size: 14px;
    margin-top: 12px;
  }

  .tab-item {
    padding: 5px 0;
    color: #0071e3;
    display: flex;
    align-items: center;
    gap: 8px;
    word-break: break-all;
  }

  .tab-item img {
    width: 16px;
    height: 16px;
    border-radius: 3px;
  }

  .status-message {
    position: fixed;
    top: 80px;
    right: 24px;
    background: #0071e3;
    color: #fff;
    padding: 10px 16px;
    border-radius: 6px;
    font-size: 14px;
    opacity: 0;
    transform: translateY(-10px);
    transition: all 0.3s ease;
  }

  .status-message.show {
    opacity: 1;
    transform: translateY(0);
  }
</style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <div class="logo">TabSync</div>
      <div class="user-section">
        <div id="userInfo" class="user-info"></div>
        <button id="logoutBtn" class="logout-btn">Sign out</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div id="loginSection" class="login-section">
      <div class="login-card">
        <h1>Welcome to TabSync</h1>
        <p style="margin:16px 0;color:#5f6368">Access your saved tab groups from any device</p>
        <button id="googleLoginBtn" class="google-login-btn">Sign in with Google</button>
      </div>
    </div>

    <div id="mainContent" class="main-content">
      <div class="stats-grid">
        <div class="stat-card">
          <div id="totalGroups" class="stat-value">0</div>
          <div class="stat-label">Saved Groups</div>
        </div>
        <div class="stat-card">
          <div id="totalTabs" class="stat-value">0</div>
          <div class="stat-label">Total Tabs</div>
        </div>
      </div>

      <div class="groups-header">
        <h2 class="groups-title">Your Tab Groups</h2>
        <button id="refreshBtn" class="refresh-btn">Refresh</button>
      </div>

      <div id="loading" class="loading">Loading your tab groups...</div>

      <div id="emptyState" class="empty-state" style="display:none">
        <div class="empty-icon">üìÅ</div>
        <h3>No tab groups yet</h3>
        <p>Install the Chrome extension to start saving tab groups</p>
      </div>

      <div id="groupsList" class="groups-list"></div>
    </div>
  </div>

  <div id="statusMessage" class="status-message"></div>

  <script>
    // ===== Config =====
    const API_BASE = 'https://tabsync-backend.onrender.com';

    // ===== State / DOM =====
    let currentUser = null;
    let groups = [];
    const loginSection = document.getElementById('loginSection');
    const mainContent = document.getElementById('mainContent');
    const userInfo = document.getElementById('userInfo');
    const logoutBtn = document.getElementById('logoutBtn');
    const googleLoginBtn = document.getElementById('googleLoginBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const loading = document.getElementById('loading');
    const emptyState = document.getElementById('emptyState');
    const groupsList = document.getElementById('groupsList');
    const totalGroups = document.getElementById('totalGroups');
    const totalTabs = document.getElementById('totalTabs');
    const statusMessage = document.getElementById('statusMessage');

    document.addEventListener('DOMContentLoaded', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const authCode = urlParams.get('code');
      if (authCode) {
        await handleAuthCallback(authCode);
      } else {
        const user = getStoredUser();
        if (user) await showDashboard(user);
        else showLogin();
      }
    });

    googleLoginBtn.addEventListener('click', handleGoogleLogin);
    logoutBtn.addEventListener('click', handleLogout);
    refreshBtn.addEventListener('click', loadGroups);

    // ===== Auth (Dashboard) =====
    async function handleGoogleLogin() {
      try {
        googleLoginBtn.disabled = true;
        googleLoginBtn.textContent = 'Signing in...';

        // Use the SAME web client as your server env
        const clientId = '754594078949-26dhhpri61i96967opn4pinbmjc208hp.apps.googleusercontent.com';
        const redirectUri = window.location.origin + window.location.pathname; // exact page URL
        const scope = 'openid email profile';

        const authUrl =
          'https://accounts.google.com/o/oauth2/v2/auth' +
          `?client_id=${encodeURIComponent(clientId)}` +
          `&redirect_uri=${encodeURIComponent(redirectUri)}` +
          `&response_type=code` +
          `&scope=${encodeURIComponent(scope)}` +
          `&access_type=offline` +
          `&prompt=consent`;

        window.location.href = authUrl;
      } catch (err) {
        console.error('Login failed:', err);
        showStatus('Sign in failed. Please try again.', 'error');
        googleLoginBtn.disabled = false;
        googleLoginBtn.textContent = 'Sign in with Google';
      }
    }

    async function handleAuthCallback(code) {
  try {
    const resp = await fetch(`${API_BASE}/auth/google/callback`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        code,
        redirect_uri: window.location.origin + window.location.pathname
      })
    });

    if (!resp.ok) {
      const detail = await resp.text(); // <-- show server‚Äôs reason
      console.error('OAuth exchange failed:', detail);
      showStatus('Authentication failed: ' + detail, 'error');
      showLogin();
      return;
    }

    const data = await resp.json();
    storeUser(data.user);
    window.history.replaceState({}, document.title, window.location.pathname);
    await showDashboard(data.user);
    showStatus('Signed in successfully!');
  } catch (err) {
    console.error('Auth callback error:', err);
    showStatus('Authentication failed. Please try again.', 'error');
    showLogin();
  }
}

    // ===== UI helpers =====
    function showLogin() {
      loginSection.style.display = 'block';
      mainContent.style.display = 'none';
      document.querySelector('.user-section').style.display = 'none';
    }

    async function showDashboard(user) {
      currentUser = user;
      loginSection.style.display = 'none';
      mainContent.style.display = 'block';
      document.querySelector('.user-section').style.display = 'flex';
      userInfo.textContent = user.email;
      await loadGroups();
    }

    function showStatus(message, type='success') {
      statusMessage.textContent = message;
      statusMessage.className = `status-message ${type} show`;
      setTimeout(() => { statusMessage.className = 'status-message'; }, 3000);
    }

    function getStoredUser() {
      const s = localStorage.getItem('tabsync_user');
      return s ? JSON.parse(s) : null;
    }
    function storeUser(user) { localStorage.setItem('tabsync_user', JSON.stringify(user)); }
    function clearStoredUser() { localStorage.removeItem('tabsync_user'); }

    // ===== Data =====
    async function loadGroups() {
      try {
        loading.style.display = 'block';
        emptyState.style.display = 'none';
        groupsList.innerHTML = '';

        const res = await fetch(`${API_BASE}/api/groups`, {
          headers: { Authorization: `Bearer ${currentUser.token}` }
        });
        if (!res.ok) throw new Error('Failed to load groups');

        const data = await res.json();
        groups = data.groups;
        loading.style.display = 'none';

        if (groups.length === 0) emptyState.style.display = 'block';
        else renderGroups();

        updateStats();
      } catch (err) {
        console.error('Failed to load groups:', err);
        loading.style.display = 'none';
        showStatus('Failed to load groups. Please try again.', 'error');
      }
    }

    function renderGroups() {
      groupsList.innerHTML = groups.map(group => `
        <div class="group-card">
          <div class="group-header">
            <div>
              <div class="group-name">${escapeHtml(group.name)}</div>
              <div class="group-meta">
                ${group.tabCount} tabs ‚Ä¢ ${formatDate(group.createdAt)}
              </div>
            </div>
            <div class="group-actions">
              <button class="open-btn" onclick="openGroup('${group.id}')">Open All</button>
              <button class="delete-btn" onclick="deleteGroup('${group.id}')">Delete</button>
            </div>
          </div>
          <div class="tab-preview">
            <div class="tab-list">
              ${group.urls.slice(0,5).map(url =>
                `<div class="tab-item">${escapeHtml(getDomainFromUrl(url))}</div>`
              ).join('')}
              ${group.urls.length > 5 ? `<div class="tab-item">...and ${group.urls.length - 5} more</div>` : ''}
            </div>
          </div>
        </div>
      `).join('');
    }

    function updateStats() {
      totalGroups.textContent = groups.length;
      totalTabs.textContent = groups.reduce((sum, g) => sum + g.tabCount, 0);
    }

function openGroup(groupId) {
  const group = groups.find(g => g.id === groupId);
  if (!group) return;

  if (group.urls.length === 0) {
    showStatus('No URLs found in this group.', 'error');
    return;
  }

  // Confirm if large group
  if (group.urls.length > 10 && !confirm(`Open ${group.urls.length} tabs in a new window?`)) return;

  // Open first tab to create the new window
  const firstUrl = group.urls[0];
  const newWindow = window.open(firstUrl, '_blank', 'noopener,noreferrer');

  if (!newWindow) {
    showStatus('Popup blocked. Please allow popups for this site.', 'error');
    return;
  }

  // Open the remaining tabs in that same new window
  setTimeout(() => {
    group.urls.slice(1).forEach(url => {
      newWindow.open(url, '_blank');
    });
  }, 500); // short delay to let first tab load

  showStatus(`Opened ${group.urls.length} tabs from "${group.name}" in a new window.`);
}

    async function deleteGroup(groupId) {
      const group = groups.find(g => g.id === groupId);
      if (!group) return;
      if (!confirm(`Delete "${group.name}"? This cannot be undone.`)) return;

      const res = await fetch(`${API_BASE}/api/groups/${groupId}`, {
        method: 'DELETE',
        headers: { Authorization: `Bearer ${currentUser.token}` }
      });
      if (!res.ok) { showStatus('Failed to delete group.', 'error'); return; }

      groups = groups.filter(g => g.id !== groupId);
      if (groups.length === 0) { emptyState.style.display = 'block'; groupsList.innerHTML = ''; }
      else renderGroups();

      updateStats();
      showStatus(`Deleted "${group.name}"`);
    }

    // ===== Utils =====
    function escapeHtml(text){const d=document.createElement('div');d.textContent=text;return d.innerHTML;}
    function formatDate(s){const d=new Date(s);return d.toLocaleDateString()+' '+d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});}
    function getDomainFromUrl(u){try{return new URL(u).hostname;}catch{return u;}}
  </script>
</body>
</html>
